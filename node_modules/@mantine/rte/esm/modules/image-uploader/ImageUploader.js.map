{"version":3,"file":"ImageUploader.js","sources":["../../../src/modules/image-uploader/ImageUploader.ts"],"sourcesContent":["interface Options {\n  upload(file: File): Promise<string>;\n}\n\nexport class ImageUploader {\n  quill: any;\n  options: Options;\n  range: any;\n  fileHolder: HTMLInputElement;\n\n  constructor(quill: any, options: Options) {\n    this.quill = quill;\n    this.options = options;\n    this.range = null;\n\n    const toolbar = this.quill.getModule('toolbar');\n    toolbar.addHandler('image', this.selectLocalImage.bind(this));\n\n    this.handleDrop = this.handleDrop.bind(this);\n    this.handlePaste = this.handlePaste.bind(this);\n\n    this.quill.root.addEventListener('drop', this.handleDrop, false);\n    this.quill.root.addEventListener('paste', this.handlePaste, false);\n  }\n\n  selectLocalImage() {\n    this.range = this.quill.getSelection();\n    this.fileHolder = document.createElement('input');\n    this.fileHolder.setAttribute('type', 'file');\n    this.fileHolder.setAttribute('accept', 'image/*');\n    this.fileHolder.setAttribute('style', 'visibility:hidden');\n\n    this.fileHolder.onchange = this.fileChanged.bind(this);\n\n    document.body.appendChild(this.fileHolder);\n\n    this.fileHolder.click();\n\n    window.requestAnimationFrame(() => {\n      document.body.removeChild(this.fileHolder);\n    });\n  }\n\n  handleDrop(event: any) {\n    event.stopPropagation();\n    event.preventDefault();\n\n    if (event.dataTransfer && event.dataTransfer.files && event.dataTransfer.files.length) {\n      if (document.caretRangeFromPoint) {\n        const selection = document.getSelection();\n        const range = document.caretRangeFromPoint(event.clientX, event.clientY);\n        if (selection && range) {\n          selection.setBaseAndExtent(\n            range.startContainer,\n            range.startOffset,\n            range.startContainer,\n            range.startOffset\n          );\n        }\n      } else {\n        const selection = document.getSelection();\n        const range = (document as any).caretPositionFromPoint(event.clientX, event.clientY);\n        if (selection && range) {\n          selection.setBaseAndExtent(\n            range.offsetNode,\n            range.offset,\n            range.offsetNode,\n            range.offset\n          );\n        }\n      }\n\n      this.range = this.quill.getSelection();\n      const file = event.dataTransfer.files[0];\n\n      setTimeout(() => {\n        this.range = this.quill.getSelection();\n        this.readAndUploadFile(file);\n      }, 0);\n    }\n  }\n\n  handlePaste(event: any) {\n    const clipboard = event.clipboardData || (window as any).clipboardData;\n\n    if (clipboard && (clipboard.items || clipboard.files)) {\n      const items = clipboard.items || clipboard.files;\n      const IMAGE_MIME_REGEX = /^image\\/(jpe?g|gif|png|svg|webp)$/i;\n\n      for (let i = 0; i < items.length; i += 1) {\n        if (IMAGE_MIME_REGEX.test(items[i].type)) {\n          const file = items[i].getAsFile ? items[i].getAsFile() : items[i];\n\n          if (file) {\n            this.range = this.quill.getSelection();\n            event.preventDefault();\n            setTimeout(() => {\n              this.range = this.quill.getSelection();\n              this.readAndUploadFile(file);\n            }, 0);\n          }\n        }\n      }\n    }\n  }\n\n  readAndUploadFile(file: File) {\n    let isUploadReject = false;\n\n    const fileReader = new FileReader();\n\n    fileReader.addEventListener(\n      'load',\n      () => {\n        if (!isUploadReject) {\n          const base64ImageSrc = fileReader.result;\n          this.insertBase64Image(base64ImageSrc as string);\n        }\n      },\n      false\n    );\n\n    if (file) {\n      fileReader.readAsDataURL(file);\n    }\n\n    this.options.upload(file).then(\n      (imageUrl) => {\n        this.insertToEditor(imageUrl);\n      },\n      () => {\n        isUploadReject = true;\n        this.removeBase64Image();\n      }\n    );\n  }\n\n  fileChanged() {\n    const file = this.fileHolder.files[0];\n    this.readAndUploadFile(file);\n  }\n\n  insertBase64Image(url: string) {\n    const { range } = this;\n    this.quill.insertEmbed(range.index, 'imageBlot', `${url}`, 'user');\n  }\n\n  insertToEditor(url: string) {\n    const { range } = this;\n    this.quill.deleteText(range.index, 3, 'user');\n    this.quill.insertEmbed(range.index, 'image', `${url}`, 'user');\n\n    range.index += 1;\n    this.quill.setSelection(range, 'user');\n  }\n\n  removeBase64Image() {\n    const { range } = this;\n    this.quill.deleteText(range.index, 3, 'user');\n  }\n}\n"],"names":[],"mappings":"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"}